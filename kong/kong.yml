_format_version: "3.0"
_transform: true

# =============================================================================
# Kong Declarative Configuration for gprint
# =============================================================================
# DB-less mode: all config lives in this file.
# Reload with: docker compose restart kong
# =============================================================================

services:
  # ── gprint API backend ────────────────────────────────────────────────────
  - name: gprint-api
    url: http://gprint:8080
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

    plugins:
      # Request logging scoped to gprint only (not global).
      # Redacts Authorization header to avoid leaking tokens in logs.
      - name: file-log
        config:
          path: /dev/stdout
          reopen: false
          custom_fields_by_lua:
            request_headers.authorization: "return nil"

    routes:
      # API routes (all /api/v1/*)
      - name: gprint-api-routes
        paths:
          - /api/v1
        strip_path: false
        preserve_host: true
        protocols:
          - http
          - https

      # Health/readiness probes (passthrough)
      - name: gprint-health
        paths:
          - /health
          - /ready
        strip_path: false
        preserve_host: true
        protocols:
          - http
          - https

# ── Global Plugins ──────────────────────────────────────────────────────────
plugins:
  # Rate limiting (global) — 100 requests/minute per IP
  # Uses Redis so counters are shared across all Kong nodes.
  - name: rate-limiting
    config:
      minute: 100
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_timeout: 2000
      fault_tolerant: true
      hide_client_headers: false
      error_code: 429
      error_message: "Rate limit exceeded. Try again later."

  # Request size limit — 10MB max
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  # CORS — explicit origin allowlist (credentials require non-wildcard origins)
  # Add every front-end origin that needs cookie / Authorization header access.
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://localhost:5173"
        # TODO: add production origin(s), e.g. https://app.example.com
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Requested-With
      exposed_headers:
        - X-Request-Id
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Correlation ID — adds X-Request-Id for tracing
  - name: correlation-id
    config:
      header_name: X-Request-Id
      generator: uuid#counter
      echo_downstream: true
